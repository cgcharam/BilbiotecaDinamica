@model IEnumerable<BilbiotecaDinamica.Models.Doc>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@{
    ViewData["Title"] = "Página Principal";
    var searchType = ViewData["SearchType"] as string ?? "title";
}

<div class="text-center">
    <h1 class="display-4">Buscar Libros</h1>
</div>

<form asp-action="Index" method="get">
    <div class="form-row">
        <div class="form-group col-md-3">
            <label for="searchType">Buscar por</label>
            <select id="searchType" name="searchType" class="form-control">
                <option value="all" selected="@(searchType == "all")">Todo</option>
                <option value="title" selected="@(searchType == "title")">Título</option>
                <option value="author" selected="@(searchType == "author")">Autor</option>
                <option value="text" selected="@(searchType == "text")">Texto</option>
                <option value="subject" selected="@(searchType == "subject")">Tema</option>
                @* <option value="lists" selected="@(searchType == "lists")">Listas</option> *@
                <option value="advanced" selected="@(searchType == "advanced")">Avanzado</option>
            </select>
        </div>
        <div class="form-group col-md-9">
            <label for="query">Término de Búsqueda</label>
            <input type="text" class="form-control" id="query" name="query" placeholder="Introduce el término de búsqueda" value="@Context.Request.Query["query"]">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Buscar</button>
</form>

<hr />

@if (Model != null && Model.Any())
{
    var allKeys = new HashSet<string>();
    foreach (var doc in Model)
    {
        if (doc.AdditionalFields != null)
        {
            foreach (var key in doc.AdditionalFields.Keys)
            {
                allKeys.Add(key);
            }
        }
    }
    allKeys.Remove("cover_i"); // Remove cover_i from the dynamic columns

    <table class="table">
        <thead>
            <tr>
                <th>Portada</th>
                <th>Título</th>
                <th>Autores</th>
                <th>Año de Primera Publicación</th>
                @if (SignInManager.IsSignedIn(User))
                {
                    <th>Acciones</th>
                }
                @* @foreach (var key in allKeys)
                {
                    <th>@key</th>
                } *@
            </tr>
        </thead>
        <tbody>
            @foreach (var doc in Model)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(doc.CoverImageUrl))
                        {
                            <img src="@doc.CoverImageUrl" alt="Portada para @doc.Title" style="max-width: 150px;" />
                        }
                    </td>
                    <td>@doc.Title</td>
                    <td>@(doc.AuthorName != null ? string.Join(", ", doc.AuthorName) : "N/A")</td>
                    <td>@doc.FirstPublishYear</td>
                    @if (SignInManager.IsSignedIn(User))
                    {
                            <td>
                            <form class="ajax-add-favorite" asp-controller="MyBooks" asp-action="Add" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                <input type="hidden" name="openLibraryId" value="@(doc.AdditionalFields != null && doc.AdditionalFields.TryGetValue("key", out var olKey) ? olKey.ToString() : "")" />
                                <input type="hidden" name="isManual" value="false" />
                                <input type="hidden" name="title" value="@doc.Title" />
                                <input type="hidden" name="author" value="@(doc.AuthorName != null ? string.Join(", ", doc.AuthorName) : "")" />
                                <input type="hidden" name="author_key" value="@(doc.author_key != null ? string.Join(", ", doc.author_key) : "")" />
                                <input type="hidden" name="coverId" value="@(doc.AdditionalFields != null && doc.AdditionalFields.TryGetValue("cover_i", out var cId) ? cId.ToString() : "")" />
                                <input type="hidden" name="firstPublishYear" value="@doc.FirstPublishYear" />
                                <input type="hidden" name="coverImageUrl" value="@doc.CoverImageUrl" />
                                <button type="submit" class="btn btn-sm btn-primary">Añadir a Mis Libros</button>
                            </form>
                        </td>
                    }
                    @* @foreach (var key in allKeys)
                    {
                        <td>
                            @if (doc.AdditionalFields != null && doc.AdditionalFields.TryGetValue(key, out var value))
                            {
                                @value
                            }
                        </td>
                    } *@
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No se encontraron resultados.</p>
}

<script>
    // Intercept AJAX add-to-favorites forms to avoid full page reload and show blocking modal
    document.addEventListener('submit', function (e) {
        var form = e.target;
        if (form && form.classList && form.classList.contains('ajax-add-favorite')) {
            e.preventDefault();
            var data = new URLSearchParams(new FormData(form));
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                body: data
            }).then(function (resp) {
                if (resp.ok) {
                    return resp.json();
                }
                return resp.text().then(function () { return { success: false, message: 'Error al añadir el libro.' }; });
            }).then(function (json) {
                var msg = (json && json.message) ? json.message : (json && json.success ? 'Libro añadido correctamente.' : 'Ocurrió un error.');
                if (window.showBlockingModal) window.showBlockingModal(msg);
            }).catch(function () {
                if (window.showBlockingModal) window.showBlockingModal('Error de red al añadir el libro.');
            });
        }
    });
</script>

